{% extends "base.html" %}
{% block title %}在庫一覧{% endblock %}
{% block content %}

<section>
  <h2>在庫一覧</h2>
  {% if low and low|length > 0 %}
    <p class="warn">⚠ 最小在庫を下回っている品目があります（赤ハイライト）</p>
  {% endif %}
  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th>商品名</th>
          <th>在庫</th>
          <th>単位</th>
          <th>最小在庫</th>
          <th>仕入先</th>
          <th>操作（±）</th>
        </tr>
      </thead>
      <tbody>
      {% for r in items %}
        <tr class="{{ 'low' if r.qty <= r.min_qty }}">
          <td>{{ r.name }}</td>
          <td class="nowrap">{{ "%.2f"|format(r.qty) }}</td>
          <td>{{ r.unit }}</td>
          <td class="nowrap">{{ r.min_qty }}</td>
          <td>{{ r.supplier }}</td>
          <td class="actions">
            <form action="{{ url_for('bump') }}" method="post">
              <input type="hidden" name="item_id" value="{{ r.id }}">
              <button type="submit" name="delta" value="-1">−1</button>
              <button type="submit" name="delta" value="1">＋1</button>
            </form>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<section class="grid">
  <div>
    <h2>仕入れ記録（登録すると在庫を自動加算）</h2>
    <form action="{{ url_for('purchase') }}" method="post" class="card">
      <label>商品
        <select name="p_item_id" required>
          {% for r in items %}
            <option value="{{ r.id }}">{{ r.name }}</option>
          {% endfor %}
        </select>
      </label>

      <label>仕入先
        <select name="p_supplier_id">
          <option value="">（指定なし）</option>
          {% for s in suppliers %}
            <option value="{{ s.id }}">{{ s.name }}</option>
          {% endfor %}
        </select>
      </label>

      <label>日付・時刻
        <input type="datetime-local" name="p_date">
      </label>

      <label>数量
        <input type="number" step="0.01" name="p_qty" placeholder="例: 2.0" required>
      </label>

      <label>仕入単価
        <input type="number" step="0.01" name="p_unit_price" placeholder="例: 350" required>
      </label>

      <label>備考
        <input type="text" name="p_note" placeholder="納品書番号など">
      </label>

      <button type="submit">登録（在庫に反映）</button>
      <p class="muted"><a href="{{ url_for('purchases_list') }}">仕入れ履歴を見る</a></p>
    </form>
  </div>

  <div>
    <h2>入出庫登録（臨時の増減・調整用）</h2>
    <form action="{{ url_for('add_tx') }}" method="post" class="card">
      <label>商品
        <select name="item_id" required>
          {% for r in items %}
            <option value="{{ r.id }}">{{ r.name }}</option>
          {% endfor %}
        </select>
      </label>

      <label>種別
        <select name="type" required>
          <option value="IN">入庫</option>
          <option value="OUT">出庫</option>
          <option value="ADJ">調整</option>
        </select>
      </label>

      <label>数量
        <input type="number" step="0.01" name="qty" placeholder="例: 2.0" required>
      </label>

      <label>備考
        <input type="text" name="note" placeholder="理由など">
      </label>

      <label>担当者
        <input type="text" name="user" placeholder="例: Okubo">
      </label>

      <button type="submit">登録</button>
      <p class="muted"><a href="{{ url_for('tx_list') }}">入出庫履歴を見る</a></p>
    </form>
  </div>
</section>

<section class="grid">
  <div>
    <h2>仕入先追加</h2>
    <form action="{{ url_for('add_supplier') }}" method="post" class="card">
      <label>仕入先名
        <input type="text" name="supplier_name" placeholder="例：○○商店" required>
      </label>
      <button type="submit">追加</button>
    </form>
  </div>

  <div>
    <h2>品目追加</h2>
    <form action="{{ url_for('add_item') }}" method="post" class="card">
      <label>商品名
        <input type="text" name="name" placeholder="例：コーヒー豆" required>
      </label>
      <label>単位
        <input type="text" name="unit" placeholder="例：kg / 本 / 個" value="個">
      </label>
      <label>最小在庫
        <input type="number" step="0.01" name="min_qty" placeholder="例：2.0" value="0">
      </label>
      <label>仕入先
        <select name="supplier_id">
          <option value="">（指定なし）</option>
          {% for s in suppliers %}
            <option value="{{ s.id }}">{{ s.name }}</option>
          {% endfor %}
        </select>
      </label>
      <button type="submit">追加</button>
    </form>
  </div>
</section>

{% endblock %}
